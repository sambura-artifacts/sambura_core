networks:
  sambura_network:
    driver: bridge
  monitoring:
    driver: bridge

volumes:
  postgres_data:
  redis_data:
  minio_data:
  rabbitmq_data:
  loki_data:
  prometheus_data:
  grafana_data:

services:
  # --- APPLICATION ---
  sambura_app:
    build:
      context: ..
      dockerfile: docker/app/Dockerfile
    volumes:
      - ./logs:/app/logs
      - ../specs:/app/specs
    container_name: sambura_app
    ports:
      - "8080:8080"
    environment:
      # Database
      DB_HOST: postgres
      DB_PORT: 5432
      DB_USER: sambura
      DB_PASSWORD: sambura_db_secret
      DB_NAME: sambura_metadata

      # Cache (Redis)
      REDIS_HOST: redis
      REDIS_PORT: 6379

      # Queue (RabbitMQ)
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_PORT: 5672
      RABBITMQ_USER: sambura_user
      RABBITMQ_PASS: sambura_mq_secret

      # Storage (MinIO)
      SILO_HOST: minio
      SILO_PORT_API: 9000
      SILO_ACCESS_KEY: sambura_admin
      SILO_SECRET_KEY: sambura_silo_secret
      BUCKET_NAME: sambura-blobs

      # Vault
      VAULT_ADDR: http://vault:8200
      VAULT_TOKEN: root_token_sambura
      VAULT_DATABASE_PATH: "secret/data/sambura/database"
      VAULT_AUTH_PATH: "secret/data/sambura/auth"

      # Logging
      LOG_LEVEL: INFO
      LOG_FILE_PATH: /app/logs
    networks:
      - sambura_network
      - monitoring
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/api/v1/system/health"]
      interval: 10s
      timeout: 5s
      retries: 5
    depends_on:
      postgres: { condition: service_healthy }
      redis: { condition: service_healthy }
      rabbitmq: { condition: service_healthy }
      minio: { condition: service_healthy }
      vault: { condition: service_healthy }
      vault_init: { condition: service_completed_successfully }
      infra_setup: { condition: service_completed_successfully }
    restart: unless-stopped

  # --- DATABASE ---
  postgres:
    image: postgres:16-alpine
    container_name: sambura_db
    environment:
      POSTGRES_USER: sambura
      POSTGRES_PASSWORD: sambura_db_secret
      POSTGRES_DB: sambura_metadata
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U sambura -d sambura_metadata"]
      interval: 5s
      retries: 5
    networks:
      - sambura_network

  # --- CACHE ---
  redis:
    image: redis:7-alpine
    container_name: sambura_cache
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
    networks:
      - sambura_network

  # --- QUEUE ---
  rabbitmq:
    image: rabbitmq:3-management-alpine
    container_name: sambura_mq
    environment:
      RABBITMQ_DEFAULT_USER: sambura_user
      RABBITMQ_DEFAULT_PASS: sambura_mq_secret
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "check_running"]
      interval: 10s
      retries: 5
    networks:
      - sambura_network

  # --- STORAGE ---
  minio:
    image: minio/minio:latest
    container_name: sambura_silo
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: sambura_admin
      MINIO_ROOT_PASSWORD: sambura_silo_secret
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 5s
    networks:
      - sambura_network

  # --- SECRETS ---
  vault:
    image: hashicorp/vault:latest
    container_name: sambura_vault
    cap_add: [IPC_LOCK]
    command: server -dev -dev-root-token-id=root_token_sambura -dev-listen-address=0.0.0.0:8200
    environment:
      VAULT_ADDR: http://127.0.0.1:8200
      VAULT_DEV_ROOT_TOKEN_ID: root_token_sambura 
    ports:
      - 8200:8200
    healthcheck:
      test: ["CMD", "vault", "status", "-address=http://0.0.0.0:8200"]
      interval: 5s
    networks:
      - sambura_network

  # --- MONITORING ---
  loki:
    image: grafana/loki:2.9.0
    container_name: sambura_loki
    ports: ["3100:3100"]
    command: -config.file=/etc/loki/local-config.yaml
    networks: ["monitoring"]

  promtail:
    image: grafana/promtail:2.9.0
    container_name: sambura_promtail
    volumes:
      - ../logs:/var/log/sambura:ro
      - ./monitoring/promtail-config.yml:/etc/promtail/config.yml
    command: -config.file=/etc/promtail/config.yml
    networks: ["monitoring"]
    depends_on: [loki]

  grafana:
    image: grafana/grafana:latest
    container_name: sambura_grafana
    ports: ["3000:3000"]
    environment:
      GF_SECURITY_ADMIN_PASSWORD: admin
    volumes:
      - ./monitoring/grafana-datasources.yml:/etc/grafana/provisioning/datasources/datasources.yml
    networks: ["monitoring"]
    depends_on: [loki]

  prometheus:
    image: prom/prometheus:latest
    container_name: sambura_prometheus
    ports: ["9090:9090"]
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
    networks: ["monitoring"]
    depends_on:
      - sambura_app

  # --- SECRET MANAGER SETUP (VAULT) ---  
  vault_init:
    image: hashicorp/vault:latest
    container_name: sambura_vault_init
    networks:
      - sambura_network
    depends_on:
      vault:
        condition: service_healthy
    environment:
      VAULT_ADDR: http://vault:8200
      VAULT_TOKEN: root_token_sambura
    entrypoint: >
      /bin/sh -c "
        sleep 2;
        vault kv put secret/sambura/database host=postgres port=5432 user=sambura password=sambura_db_secret name=sambura_metadata;
        vault kv put secret/sambura/auth jwt_secret=chave_mestra token_expiration=3600;
        vault kv put secret/sambura/auth jwt_secret=chave_mestra_sambura_2025 pepper=pimenta_no_reino;
        echo 'Segredos injetados!';"
  
  # --- INFRA SETUP (DB Tables + MinIO Buckets) ---
  infra_setup:
    image: alpine:latest
    container_name: sambura_infra_setup
    networks:
      - sambura_network
    depends_on:
      postgres: { condition: service_healthy }
      minio: { condition: service_healthy }
    volumes:
      - ../sql:/sql
    environment:
      PGPASSWORD: sambura_db_secret
      AWS_ACCESS_KEY_ID: sambura_admin
      AWS_SECRET_ACCESS_KEY: sambura_silo_secret
    entrypoint: >
      /bin/sh -c "
        apk add --no-cache postgresql-client aws-cli;
        echo 'ðŸ—ï¸  Iniciando DB Init...';
        psql -h postgres -U sambura -d sambura_metadata -f /sql/init.sql;
        echo 'ðŸ“¥ Configurando bucket no MinIO...';
        aws --endpoint-url http://minio:9000 s3 mb s3://sambura-blobs 2>/dev/null || echo 'âœ… Bucket jÃ¡ existe.';
        echo 'ðŸš€ INFRA PRONTA!';"

