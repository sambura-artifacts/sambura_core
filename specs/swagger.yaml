openapi: 3.0.3
info:
  title: Sambur치 Docs - API de Elite
  description: |
    Proxy de artefatos NPM com persist칡ncia em S3 e Postgres.
    
    ## Autentica칞칚o
    A maioria dos endpoints requer autentica칞칚o via JWT Token ou API Key:
    - **Bearer Token**: Use `Authorization: Bearer <token>` para endpoints autenticados
    - **API Key**: Use `X-API-Key: <api_key>` para integra칞칚o de sistemas
    
    ## Fluxo de Uso
    1. Registre um usu치rio via `/api/v1/auth/register`
    2. Fa칞a login via `/api/v1/auth/login` para obter o token JWT
    3. Crie uma API Key via `/api/v1/admin/api-keys` para upload automatizado
    4. Crie reposit칩rios via `/api/v1/admin/repositories`
    5. Fa칞a upload de artefatos via `/api/v1/admin/upload` ou `/api/v1/upload`
    6. Resolva artefatos via `/api/v1/{repositoryName}/{packageName}/{version}`
    7. Baixe artefatos via `/api/v1/download/{namespace}/{name}/{version}`
    
    ## Estrutura de Rotas
    - `/api/v1/auth/*` - Autentica칞칚o p칰blica (registro e login)
    - `/api/v1/admin/*` - Gerenciamento de recursos (requer autentica칞칚o)
    - `/api/v1/npm/*` - Compatibilidade com NPM Registry
    - `/api/v1/{repo}/{package}/{version}` - Resolu칞칚o de artefatos
    - `/api/v1/download/*` - Download de artefatos
    - `/api/v1/blobs/*` - Download direto de blobs
    - `/api/v1/docs` - Documenta칞칚o Swagger UI
    
  version: 1.0.0
  contact:
    name: Sambur치 Core
    url: https://github.com/sambura

servers:
  - url: http://localhost:8080
    description: Servidor Local
  - url: https://api.sambura.io
    description: Servidor de Produ칞칚o

tags:
  - name: Auth
    description: Autentica칞칚o e registro de usu치rios
  - name: Admin - Repositories
    description: Gerenciamento de reposit칩rios (requer autentica칞칚o)
  - name: Admin - Packages
    description: Listagem de pacotes (requer autentica칞칚o)
  - name: Admin - Artifacts
    description: Gerenciamento de artefatos (requer autentica칞칚o)
  - name: Admin - API Keys
    description: Gerenciamento de chaves de API (requer autentica칞칚o)
  - name: Artifacts
    description: Resolu칞칚o e download de artefatos
  - name: NPM
    description: Endpoints compat칤veis com NPM Registry
  - name: Upload
    description: Upload de artefatos (requer autentica칞칚o)
  - name: Blobs
    description: Download de blobs bin치rios
  - name: Docs
    description: Documenta칞칚o da API

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: Token JWT obtido via login
    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key
      description: API Key para integra칞칚o de sistemas

  schemas:
    Error:
      type: object
      properties:
        error:
          type: string
          description: Mensagem de erro
        message:
          type: string
          description: Descri칞칚o detalhada
        instance:
          type: string
          description: Path da requisi칞칚o
        
    Account:
      type: object
      properties:
        username:
          type: string
          example: "matheus"
        email:
          type: string
          format: email
          example: "matheus@sambura.io"
        password:
          type: string
          format: password
          example: "senha123"
        role:
          type: string
          enum: [admin, developer]
          default: developer
          
    LoginResponse:
      type: object
      properties:
        token:
          type: string
          description: Token JWT para autentica칞칚o
        username:
          type: string
          description: Nome do usu치rio
          
    Repository:
      type: object
      required:
        - name
        - namespace
      properties:
        id:
          type: integer
          description: ID do reposit칩rio
        name:
          type: string
          example: "my-repo"
          description: Nome do reposit칩rio
        namespace:
          type: string
          example: "@sambura"
          description: Namespace do reposit칩rio
        is_public:
          type: boolean
          default: false
          description: Se o reposit칩rio 칠 p칰blico
        created_at:
          type: string
          format: date-time
          
    Package:
      type: object
      properties:
        id:
          type: integer
        name:
          type: string
          example: "@sambura/core"
        repository_id:
          type: integer
        versions:
          type: array
          items:
            type: string
          example: ["1.0.0", "1.0.1", "1.1.0"]
          
    Artifact:
      type: object
      properties:
        external_id:
          type: string
          format: uuid
          description: UUID do artefato
        namespace:
          type: string
          example: "@sambura"
        package_name:
          type: string
          example: "core-lib"
        version:
          type: string
          example: "1.0.0"
        path:
          type: string
          example: "/libs/core-lib-1.0.0.tgz"
        repository_id:
          type: integer
        package_id:
          type: integer
        blob_id:
          type: integer
        created_at:
          type: string
          format: date-time
          
    ApiKey:
      type: object
      properties:
        id:
          type: integer
        name:
          type: string
          example: "minha-chave-de-upload"
        prefix:
          type: string
          example: "smb_"
          description: Prefixo da chave
        api_key:
          type: string
          description: Chave completa (retornada apenas na cria칞칚o)
        last_used_at:
          type: string
          format: date-time
        created_at:
          type: string
          format: date-time
          
    NPMMetadata:
      type: object
      description: Metadados no formato do NPM Registry
      properties:
        name:
          type: string
        versions:
          type: object
          additionalProperties:
            type: object
        dist-tags:
          type: object
          additionalProperties:
            type: string

paths:
  # ===== AUTH =====
  /api/v1/auth/register:
    post:
      summary: Registra um novo usu치rio
      description: Cria uma nova conta no sistema
      tags:
        - Auth
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - username
                - password
                - email
              properties:
                username:
                  type: string
                  example: "matheus"
                password:
                  type: string
                  format: password
                  example: "senha123"
                email:
                  type: string
                  format: email
                  example: "matheus@sambura.io"
                role:
                  type: string
                  enum: [admin, developer]
                  default: developer
      responses:
        '200':
          description: Usu치rio criado com sucesso
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Usu치rio criado com sucesso, cria!"
        '500':
          description: Erro no cadastro
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/v1/auth/login:
    post:
      summary: Faz login no sistema
      description: Autentica o usu치rio e retorna um token JWT
      tags:
        - Auth
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - username
                - password
              properties:
                username:
                  type: string
                  example: "matheus"
                password:
                  type: string
                  format: password
                  example: "senha123"
      responses:
        '200':
          description: Login realizado com sucesso
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LoginResponse'
        '403':
          description: Credenciais inv치lidas
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Erro no servidor
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  # ===== ADMIN - REPOSITORIES =====
  /api/v1/admin/repositories:
    get:
      summary: Lista todos os reposit칩rios
      description: Retorna uma lista paginada de reposit칩rios
      tags:
        - Admin - Repositories
      security:
        - BearerAuth: []
        - ApiKeyAuth: []
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            default: 10
            minimum: 1
            maximum: 100
          description: N칰mero de itens por p치gina
        - name: offset
          in: query
          schema:
            type: integer
            default: 0
            minimum: 0
          description: Offset para pagina칞칚o
      responses:
        '200':
          description: Lista de reposit칩rios
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items:
                      $ref: '#/components/schemas/Repository'
                  total:
                    type: integer
                  limit:
                    type: integer
                  offset:
                    type: integer
        '401':
          description: N칚o autenticado
        '500':
          description: Erro no servidor
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    
    post:
      summary: Cria um novo reposit칩rio
      description: Cria um reposit칩rio para armazenar pacotes
      tags:
        - Admin - Repositories
      security:
        - BearerAuth: []
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - name
                - namespace
              properties:
                name:
                  type: string
                  example: "my-repo"
                namespace:
                  type: string
                  example: "@sambura"
                is_public:
                  type: boolean
                  default: false
      responses:
        '200':
          description: Reposit칩rio criado com sucesso
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Repository'
        '400':
          description: Dados inv치lidos
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: N칚o autenticado
        '500':
          description: Erro no servidor
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  # ===== ADMIN - PACKAGES =====
  /api/v1/admin/packages:
    get:
      summary: Lista todos os pacotes do sistema
      description: Retorna uma lista global de todos os pacotes
      tags:
        - Admin - Packages
      security:
        - BearerAuth: []
        - ApiKeyAuth: []
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            default: 50
            minimum: 1
            maximum: 100
        - name: offset
          in: query
          schema:
            type: integer
            default: 0
            minimum: 0
      responses:
        '200':
          description: Lista de pacotes
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items:
                      $ref: '#/components/schemas/Package'
                  total:
                    type: integer
                  limit:
                    type: integer
                  offset:
                    type: integer
        '401':
          description: N칚o autenticado
        '500':
          description: Erro no servidor

  /api/v1/admin/repositories/{repoName}/packages:
    get:
      summary: Lista pacotes de um reposit칩rio espec칤fico
      description: Retorna todos os pacotes de um reposit칩rio
      tags:
        - Admin - Packages
      security:
        - BearerAuth: []
        - ApiKeyAuth: []
      parameters:
        - name: repoName
          in: path
          required: true
          schema:
            type: string
          description: Nome do reposit칩rio
          example: "my-repo"
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
            minimum: 1
            maximum: 100
        - name: offset
          in: query
          schema:
            type: integer
            default: 0
            minimum: 0
      responses:
        '200':
          description: Lista de pacotes do reposit칩rio
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items:
                      $ref: '#/components/schemas/Package'
        '401':
          description: N칚o autenticado
        '404':
          description: Reposit칩rio n칚o encontrado
        '500':
          description: Erro no servidor

  # ===== ADMIN - ARTIFACTS =====
  /api/v1/admin/artifacts/{externalId}:
    get:
      summary: Busca artefato por ID
      description: Retorna os metadados de um artefato espec칤fico pelo UUID
      tags:
        - Admin - Artifacts
      security:
        - BearerAuth: []
        - ApiKeyAuth: []
      parameters:
        - name: externalId
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: UUID do artefato
      responses:
        '200':
          description: Artefato encontrado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Artifact'
        '401':
          description: N칚o autenticado
        '404':
          description: Artefato n칚o encontrado
        '500':
          description: Erro no servidor

  # ===== ADMIN - API KEYS =====
  /api/v1/admin/api-keys:
    get:
      summary: Lista as API Keys do usu치rio
      description: Retorna todas as chaves de API do usu치rio autenticado
      tags:
        - Admin - API Keys
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Lista de API Keys
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    id:
                      type: integer
                    name:
                      type: string
                    prefix:
                      type: string
                    last_used_at:
                      type: string
                      format: date-time
                    created_at:
                      type: string
                      format: date-time
        '401':
          description: N칚o autenticado
    
    post:
      summary: Cria uma nova API Key
      description: Gera uma nova chave de API para o usu치rio autenticado
      tags:
        - Admin - API Keys
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - name
              properties:
                name:
                  type: string
                  example: "minha-chave-de-upload"
                  description: Nome descritivo para a chave
      responses:
        '200':
          description: Chave criada com sucesso
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Chave forjada com sucesso! Guarda bem, ela n칚o aparece de novo."
                  name:
                    type: string
                  api_key:
                    type: string
                    description: Chave completa - salve em local seguro!
        '400':
          description: Nome da chave n칚o fornecido
        '401':
          description: N칚o autenticado
        '500':
          description: Erro ao gerar a chave

  /api/v1/admin/api-keys/{id}:
    delete:
      summary: Revoga uma API Key
      description: Deleta/revoga uma chave de API espec칤fica
      tags:
        - Admin - API Keys
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
          description: ID da chave a ser revogada
      responses:
        '200':
          description: Chave revogada com sucesso
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Chave incinerada com sucesso!"
        '400':
          description: ID inv치lido
        '401':
          description: N칚o autenticado
        '404':
          description: Chave n칚o encontrada

  # ===== UPLOAD =====
  /api/v1/admin/upload:
    post:
      summary: Faz upload de um artefato
      description: Upload de artefatos via multipart/form-data
      tags:
        - Upload
      security:
        - BearerAuth: []
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required:
                - file
                - package
                - version
              properties:
                file:
                  type: string
                  format: binary
                  description: Arquivo .tgz do pacote
                package:
                  type: string
                  example: "@sambura/core"
                version:
                  type: string
                  example: "1.0.0"
                repository:
                  type: string
                  default: "default"
                  example: "my-repo"
      responses:
        '200':
          description: Artefato enviado com sucesso
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Artefato no ninho! 游"
        '400':
          description: Dados incompletos ou formato inv치lido
        '401':
          description: N칚o autenticado
        '500':
          description: Erro no processamento

  /api/v1/upload:
    post:
      summary: Faz upload de um artefato (alternativa)
      description: Upload de artefatos via multipart/form-data (endpoint alternativo na raiz do /api/v1)
      tags:
        - Upload
      security:
        - BearerAuth: []
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required:
                - file
                - package
                - version
              properties:
                file:
                  type: string
                  format: binary
                  description: Arquivo .tgz do pacote
                package:
                  type: string
                  example: "@sambura/core"
                version:
                  type: string
                  example: "1.0.0"
                repository:
                  type: string
                  default: "default"
                  example: "my-repo"
      responses:
        '200':
          description: Artefato enviado com sucesso
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Artefato no ninho! 游"
        '400':
          description: Dados incompletos ou formato inv치lido
        '401':
          description: N칚o autenticado
        '500':
          description: Erro no processamento

  # ===== ARTIFACTS - RESOLVE & DOWNLOAD =====
  /api/v1/{repositoryName}/{packageName}/{version}:
    get:
      summary: Resolve a localiza칞칚o de um artefato
      description: Busca artefato no banco ou faz proxy do NPM Registry
      tags:
        - Artifacts
      security:
        - BearerAuth: []
        - ApiKeyAuth: []
      parameters:
        - name: repositoryName
          in: path
          required: true
          schema:
            type: string
          example: "my-repo"
          description: Nome do reposit칩rio
        - name: packageName
          in: path
          required: true
          schema:
            type: string
          example: "@sambura/core"
          description: Nome do pacote (pode incluir namespace)
        - name: version
          in: path
          required: true
          schema:
            type: string
          example: "1.0.0"
          description: Vers칚o do pacote
      responses:
        '200':
          description: Artefato encontrado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Artifact'
        '401':
          description: N칚o autenticado
        '404':
          description: Artefato n칚o encontrado
        '500':
          description: Erro no servidor

  /api/v1/download/{namespace}/{name}/{version}:
    get:
      summary: Download de artefato
      description: Faz o download do arquivo bin치rio do artefato
      tags:
        - Artifacts
      security:
        - BearerAuth: []
        - ApiKeyAuth: []
      parameters:
        - name: namespace
          in: path
          required: true
          schema:
            type: string
          example: "@sambura"
          description: Namespace do pacote (escopo)
        - name: name
          in: path
          required: true
          schema:
            type: string
          example: "core"
          description: Nome do pacote sem namespace
        - name: version
          in: path
          required: true
          schema:
            type: string
          example: "1.0.0"
          description: Vers칚o do pacote
      responses:
        '200':
          description: Download iniciado
          content:
            application/octet-stream:
              schema:
                type: string
                format: binary
          headers:
            Content-Type:
              schema:
                type: string
            Content-Length:
              schema:
                type: integer
            Content-Disposition:
              schema:
                type: string
        '401':
          description: N칚o autenticado
        '404':
          description: Artefato n칚o encontrado
        '500':
          description: Erro no servidor

  # ===== NPM COMPATIBLE =====
  /api/v1/npm/{repo}/{packageName}:
    get:
      summary: Obt칠m metadados do pacote (NPM-compatible)
      description: Retorna metadados no formato do NPM Registry para compatibilidade com clientes NPM
      tags:
        - NPM
      parameters:
        - name: repo
          in: path
          required: true
          schema:
            type: string
          example: "my-repo"
        - name: packageName
          in: path
          required: true
          schema:
            type: string
          description: Nome do pacote (pode conter escopo com @)
          example: "@sambura/core"
      responses:
        '200':
          description: Metadados do pacote
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/NPMMetadata'
        '404':
          description: Pacote n칚o encontrado
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "Package not found"

  # ===== BLOBS =====
  /api/v1/blobs/{hash}:
    get:
      summary: Download de blob por hash
      description: Faz o download direto de um blob bin치rio pelo seu hash
      tags:
        - Blobs
      security:
        - BearerAuth: []
        - ApiKeyAuth: []
      parameters:
        - name: hash
          in: path
          required: true
          schema:
            type: string
          description: Hash SHA-256 do blob
          example: "a3b2c1d4e5f6..."
      responses:
        '200':
          description: Download do blob
          content:
            application/octet-stream:
              schema:
                type: string
                format: binary
          headers:
            Content-Type:
              schema:
                type: string
            Content-Length:
              schema:
                type: integer
            Content-Disposition:
              schema:
                type: string
        '401':
          description: N칚o autenticado
        '404':
          description: Blob n칚o encontrado
        '500':
          description: Erro no servidor

  # ===== SWAGGER UI =====
  /api/v1/docs:
    get:
      summary: Documenta칞칚o Swagger UI
      description: Interface gr치fica da documenta칞칚o da API
      tags:
        - Docs
      responses:
        '200':
          description: P치gina HTML do Swagger UI