openapi: 3.0.3
info:
  title: Sambur√° Core - API de Gerenciamento de Artefatos
  description: |
    Proxy de artefatos NPM com persist√™ncia em S3/MinIO e PostgreSQL.
    
    ## ‚ö†Ô∏è ESTADO ATUAL DA IMPLEMENTA√á√ÉO
    
    Esta API est√° em desenvolvimento ativo. Nem todas as funcionalidades documentadas
    est√£o conectadas e dispon√≠veis para uso.
    
    ### ‚úÖ Rotas Funcionais (Conectadas no MainRouter)
    - `POST /api/v1/auth/register` - Registro de usu√°rios (requer autentica√ß√£o)
    - `POST /api/v1/auth/login` - Login e gera√ß√£o de JWT
    - `GET  /api/v1/system/*` - Health check e status do sistema
    
    ### üöß Controllers Implementados mas N√ÉO Conectados
    Os seguintes controllers est√£o prontos mas n√£o foram montados no MainRouter:
    - **ApiKeyController**: Gerenciamento de API Keys (CRUD completo)
    - **RepositoryController**: CRUD de reposit√≥rios
    - **PackageController**: Listagem de pacotes e metadados NPM
    - **ArtifactController**: Resolu√ß√£o e download de artefatos
    - **BlobController**: Download direto de blobs pelo hash
    - **UploadController**: Upload multipart e npm publish
    
    ### üìù Pr√≥ximos Passos para Conex√£o
    1. Edite: `lib/infrastructure/api/routes/main_router.dart`
    2. Injete os controllers no construtor
    3. Monte as rotas usando `.mount()` ou handlers diretos
    4. Teste cada endpoint
    
    ## Autentica√ß√£o
    A maioria dos endpoints requer autentica√ß√£o via:
    - **Bearer Token**: `Authorization: Bearer <token>`
    - **API Key**: `X-API-Key: <api_key>` (quando implementado)
    
  version: 1.0.0
  contact:
    name: Sambur√° Core GitHub Repository
    url: https://github.com/sambura-artifacts/sambura_core

servers:
  - url: http://localhost:8080
    description: Servidor Local
  - url: https://dev.api.sambura.io
    description: Desenvolvimento
  - url: https://api.sambura.io
    description: Produ√ß√£o

tags:
  - name: Auth
    description: Autentica√ß√£o e registro (funcional)
  - name: System
    description: Health check e status (funcional)
  - name: Admin - API Keys
    description: Gerenciamento de API Keys (implementado, n√£o conectado)
  - name: Admin - Repositories
    description: CRUD de reposit√≥rios (implementado, n√£o conectado)
  - name: Admin - Packages
    description: Listagem de pacotes (implementado, n√£o conectado)
  - name: NPM
    description: Metadados NPM (implementado, n√£o conectado)
  - name: Upload
    description: Upload de artefatos (implementado, n√£o conectado)
  - name: Artifacts
    description: Resolu√ß√£o e download (implementado, n√£o conectado)

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: Token JWT obtido via login
    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key
      description: API Key para integra√ß√£o (quando conectado)

  schemas:
    Error:
      type: object
      properties:
        error:
          type: string
        message:
          type: string
        instance:
          type: string
          
    Account:
      type: object
      properties:
        username:
          type: string
        email:
          type: string
          format: email
        role:
          type: string
          enum: [admin, developer]
          
    LoginResponse:
      type: object
      properties:
        token:
          type: string
        username:
          type: string
          
    Repository:
      type: object
      properties:
        id:
          type: integer
        name:
          type: string
        namespace:
          type: string
        is_public:
          type: boolean
        created_at:
          type: string
          format: date-time
          
    Package:
      type: object
      properties:
        id:
          type: integer
        name:
          type: string
        repository_id:
          type: integer
        versions:
          type: array
          items:
            type: string

paths:
  # ========================================
  # ROTAS FUNCIONAIS (CONECTADAS)
  # ========================================
  
  /api/v1/auth/login:
    post:
      summary: Login no sistema
      description: |
        ‚úÖ **FUNCIONAL** - Rota conectada e operacional.
        
        Autentica o usu√°rio e retorna um JWT para uso nas demais rotas protegidas.
      tags:
        - Auth
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - username
                - password
              properties:
                username:
                  type: string
                  example: "matheus"
                password:
                  type: string
                  format: password
                  example: "senha123"
      responses:
        '200':
          description: Login realizado com sucesso
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LoginResponse'
        '403':
          description: Credenciais inv√°lidas
        '500':
          description: Erro no servidor

  /api/v1/auth/register:
    post:
      summary: Registro de novo usu√°rio
      description: |
        ‚úÖ **FUNCIONAL** - Rota conectada mas requer autentica√ß√£o pr√©via.
        
        Cria uma nova conta no sistema. Atualmente montada no `protectedRouter`,
        ou seja, requer um token JWT v√°lido.
      tags:
        - Auth
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - username
                - password
                - email
              properties:
                username:
                  type: string
                password:
                  type: string
                  format: password
                email:
                  type: string
                  format: email
                role:
                  type: string
                  enum: [admin, developer]
                  default: developer
      responses:
        '200':
          description: Usu√°rio criado
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
        '401':
          description: N√£o autenticado
        '500':
          description: Erro no servidor

  /api/v1/system/health:
    get:
      summary: Health check do sistema
      description: |
        ‚úÖ **FUNCIONAL** - Rota p√∫blica conectada via SystemController.
        
        Verifica o status do servidor e depend√™ncias (DB, MinIO, etc).
      tags:
        - System
      responses:
        '200':
          description: Sistema operacional
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                  timestamp:
                    type: string
                    format: date-time
        '500':
          description: Sistema com problemas

  # ========================================
  # ROTAS N√ÉO CONECTADAS (IMPLEMENTADAS)
  # ========================================
  
  /api/v1/admin/api-keys:
    get:
      summary: Lista API Keys do usu√°rio
      description: |
        üöß **N√ÉO CONECTADO** - Controller implementado, precisa ser montado no MainRouter.
        
        ```dart
        // Adicione no MainRouter:
        protectedRouter.mount('/admin/api-keys', _apiKeyController.router.call);
        ```
      tags:
        - Admin - API Keys
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Lista de chaves
        '401':
          description: N√£o autenticado
          
    post:
      summary: Cria nova API Key
      description: |
        üöß **N√ÉO CONECTADO** - Controller implementado.
      tags:
        - Admin - API Keys
      security:
        - BearerAuth: []
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required:
                - name
              properties:
                name:
                  type: string
      responses:
        '200':
          description: Chave criada

  /api/v1/admin/api-keys/{id}:
    delete:
      summary: Revoga uma API Key
      description: |
        üöß **N√ÉO CONECTADO**
      tags:
        - Admin - API Keys
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Chave revogada

  /api/v1/admin/repositories:
    get:
      summary: Lista reposit√≥rios
      description: |
        üöß **N√ÉO CONECTADO** - RepositoryController implementado.
      tags:
        - Admin - Repositories
      security:
        - BearerAuth: []
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            default: 10
        - name: offset
          in: query
          schema:
            type: integer
            default: 0
      responses:
        '200':
          description: Lista de reposit√≥rios
          
    post:
      summary: Cria reposit√≥rio
      description: |
        üöß **N√ÉO CONECTADO**
      tags:
        - Admin - Repositories
      security:
        - BearerAuth: []
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required:
                - name
                - namespace
              properties:
                name:
                  type: string
                namespace:
                  type: string
                is_public:
                  type: boolean
      responses:
        '200':
          description: Reposit√≥rio criado

  /api/v1/admin/packages:
    get:
      summary: Lista todos os pacotes
      description: |
        üöß **N√ÉO CONECTADO** - PackageController implementado.
      tags:
        - Admin - Packages
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Lista de pacotes

  /api/v1/npm/private-repo/{packageName}:
    get:
      summary: Metadados NPM de um pacote
      description: |
        üöß **N√ÉO CONECTADO** - PackageController.getMetadata() implementado.
        
        Endpoint consultado pelo NPM CLI antes de instalar/publicar.
      tags:
        - NPM
      security:
        - BearerAuth: []
      parameters:
        - name: packageName
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Metadados do pacote
        '404':
          description: Pacote n√£o encontrado

  /api/v1/upload:
    post:
      summary: Upload de artefato (POST)
      description: |
        üöß **N√ÉO CONECTADO** - UploadController.handle() implementado.
        
        Suporta multipart/form-data e JSON (npm publish).
      tags:
        - Upload
      security:
        - BearerAuth: []
        - ApiKeyAuth: []
      requestBody:
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                file:
                  type: string
                  format: binary
                package:
                  type: string
                version:
                  type: string
      responses:
        '200':
          description: Upload realizado
          
    put:
      summary: Upload de artefato (PUT)
      description: |
        üöß **N√ÉO CONECTADO** - Compat√≠vel com `npm publish`.
      tags:
        - Upload
      security:
        - BearerAuth: []
      requestBody:
        content:
          application/json:
            schema:
              type: object
      responses:
        '200':
          description: Pacote publicado

# ========================================
# INSTRU√á√ïES PARA DESENVOLVEDORES
# ========================================
#
# Para conectar os controllers n√£o montados:
#
# 1. Edite: lib/infrastructure/api/routes/main_router.dart
#
# 2. Adicione os controllers no construtor:
#    ```dart
#    final ApiKeyController _apiKeyController;
#    final RepositoryController _repositoryController;
#    final PackageController _packageController;
#    final UploadController _uploadController;
#    final ArtifactController _artifactController;
#    final BlobController _blobController;
#    ```
#
# 3. Injete via DI no server.dart:
#    ```dart
#    final mainRouter = MainRouter(
#      di.authController,
#      di.systemController,
#      di.apiKeyController,     // adicione
#      di.repositoryController,  // adicione
#      // ... etc
#    );
#    ```
#
# 4. Monte as rotas no handler getter:
#    ```dart
#    protectedRouter.mount('/admin/api-keys', _apiKeyController.router.call);
#    protectedRouter.mount('/admin/repositories', _repositoryController.router.call);
#    protectedRouter.post('/upload', _uploadController.handle);
#    protectedRouter.put('/upload', _uploadController.handle);
#    ```
#
# 5. Teste cada rota ap√≥s conectar
#
# ========================================
